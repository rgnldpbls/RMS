@using System.Security.Claims
@model IEnumerable<rscSys_final.Models.Memorandum>

@{
    ViewData["Title"] = "Chief Dashboard";
    Layout = "_LayoutCNAV";
}

<style>
    .dash {
        font-weight: 800;
        font-size: 50px;
    }

    .lead {
        font-weight: 700;
    }

    .cardspent {
        background-color: #850000;
    }

    .Gendorsed {
        display: flex;
        background-color: #850000;
        color: white;
        font-weight: 600;
        font-size: 20px;
    }

    .Iendorsed {
        display: flex;
        background-color: #ffc107;
        color: #850000;
        font-weight: 600;
        font-size: 20px;
    }

    .Aendorsed {
        display: flex;
        background-color: #198754;
        color: white;
        font-weight: 600;
        font-size: 20px;
    }

    .card-body .text{
        color: #850000;
    }

    .totalSpent {
        font-size: 70px;
    }

    .calendar {
        flex: 2;
        width: 100%;
        background-color: #f8f9fa; /* Light gray */
        border-radius: 8px;
        border: 2px solid #850000;
        padding: 10px;
        margin-right: 20px;
    }
</style>

<div class="container mt-4 dashboard">
    <h1 class="mb-0 dash">Dashboard</h1>
    <p class="lead">Welcome, RSC Chief!</p>

    <div id="calendar" class="calendar mb-3"></div>

    <div class="row g-4">
        <div class="col-md-8">
            <a href="@Url.Action("Forecasting", "RSCChief")" class="text-decoration-none">
                <div class="card bg-danger text-white mb-4">
                    <div class="card-body text-center cardspent">
                        <h5 class="card-title">TOTAL SPENT ON ALL SERVICES</h5>
                        <h1 class="display-4 fw-bold totalSpent">PHP @ViewBag.TotalSpent.ToString("N0")</h1>
                    </div>
                </div>
            </a>

            <div class="mt-4">
                <a href="@Url.Action("Applications", "RSCChief")" class="text-decoration-none">
                    <div class="card bg-primary text-white mb-4">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Pending Evaluations</h5>
                            <h1 class="display-4 fw-bold">@ViewBag.TotalPendingEvaluations</h1>
                        </div>
                    </div>
                </a>
            </div>

            <div class="row g-4">
                <div class="col-md-4">
                    <a href="@Url.Action("GrantsOverview", "RSCChief")" class="text-decoration-none">
                        <div class="card bg-white">
                            <div class="card-body text-center">
                                <h2 class="text">@ViewBag.TotalGrants</h2>
                                <p class="mb-0 text"><strong>TOTAL</strong></p>
                            </div>
                            <div class="card-footer justify-content-center text-center Gendorsed">
                                Grants<br />Endorsed
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="@Url.Action("IncentivesOverview", "RSCChief")" class="text-decoration-none">
                    <div class="card bg-white">
                        <div class="card-body text-center">
                            <h2 class="text-warning">@ViewBag.TotalIncentives</h2>
                            <p class="mb-0 text-warning"><strong>TOTAL</strong></p>
                        </div>
                        <div class="card-footer justify-content-center text-center Iendorsed">
                            Incentives<br />Endorsed
                        </div>
                    </div>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="@Url.Action("AssistanceOverview", "RSCChief")" class="text-decoration-none">
                    <div class="card bg-white">
                        <div class="card-body text-center">
                            <h2 class="text-success">@ViewBag.TotalAssistance</h2>
                            <p class="mb-0 text-success"><strong>TOTAL</strong></p>
                        </div>
                        <div class="card-footer justify-content-center text-center Aendorsed">
                            Assistance<br />Endorsed
                        </div>
                    </div>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">Application Request Summary</h5>
                    <div class="text-center">
                        <canvas id="applicationSummaryChart" width="200" height="200"></canvas>
                    </div>
                    <div class="mt-4" id="chartLegend"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var ctx = document.getElementById('applicationSummaryChart').getContext('2d');
            var data = {
                labels: ['Pending', 'Approved', 'Rejected'],
                datasets: [{
                    data: [@ViewBag.Pending, @ViewBag.Approved, @ViewBag.Rejected],
                    backgroundColor: ['#A9A9A9', '#2E8B57', '#8B0000']
                }]
            };
            var myPieChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            var legendHtml = '';
            data.labels.forEach(function (label, index) {
                legendHtml += '<div class="d-flex justify-content-between align-items-center mb-2">' +
                    '<div><span class="me-2" style="display: inline-block; width: 20px; height: 20px; background-color: ' +
                    data.datasets[0].backgroundColor[index] + ';"></span>' + label + '</div>' +
                    '<span>' + data.datasets[0].data[index] + '%</span></div>';
            });
            document.getElementById('chartLegend').innerHTML = legendHtml;
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var modal = new bootstrap.Modal(document.querySelector('.modal'));

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                events: '/RscSys/RSCChief/GetCalendarEvents',
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: true
                },
                eventClick: function (info) {
                    showEventDetails(info.event);
                },
                eventDidMount: function (info) {
                    // Add tooltip with event details
                    $(info.el).tooltip({
                        title: `
                                    ${info.event.title}
                                    Time: ${moment(info.event.start).format('hh:mm A')} - ${moment(info.event.end).format('hh:mm A')}
                                    Location: ${info.event.extendedProps.location}
                                    Type: ${info.event.extendedProps.eventType}
                                `,
                        html: true,
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                },
                dayMaxEvents: true, // allow "more" link when too many events
                themeSystem: 'bootstrap5',
                height: 'auto',
                contentHeight: 'auto'
            });

            calendar.render();

            function showEventDetails(event) {
                const modal = document.querySelector('.modal');
                const modalBody = modal.querySelector('.modal-body');

                // Clear previous form
                modalBody.innerHTML = `
                            <div class="event-details">
                                <h3 class="mb-3">${event.title}</h3>
                                <p><strong>Date:</strong> ${moment(event.start).format('MMMM D, YYYY')}</p>
                                <p><strong>Time:</strong> ${moment(event.start).format('hh:mm A')} - ${moment(event.end).format('hh:mm A')}</p>
                                <p><strong>Location:</strong> ${event.extendedProps.location}</p>
                                <p><strong>Type:</strong> ${event.extendedProps.eventType}</p>
                                <p><strong>Description:</strong></p>
                                <p>${event.extendedProps.description}</p>
                            </div>
                        `;

                // Show the modal
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            }

            // Refresh calendar events every 5 minutes
            setInterval(function () {
                calendar.refetchEvents();
            }, 300000);
        });
    </script>
}
